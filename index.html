<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Harmonic Collection</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- persistent hidden audio lives here so it never unloads during PJAX navigation -->
    <audio id="bg-audio" autoplay loop muted preload="auto" class="hidden-audio">
        <source src="audio/SpotiDownloader.com - Rencontre 2014 - Bertrand Bonello.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- page content container swapped by PJAX -->
    <main id="pjax-content">
        <a id="entries-link" href="entry-homepage/index.html" title="Open entries">
            <img id="entries-image" src="images/digital-darkrrom-final-copy.jpg" alt="Open entries" width="800" class="center-img">
        </a>
    </main>

    <!-- PJAX navigation: fetch pages and replace #pjax-content so the audio element remains loaded -->
    <script>
        (function(){
            const audio = document.getElementById('bg-audio');
            // ensure audio starts muted (autoplay policies)
            if(audio){ audio.volume = 0.8; audio.play().catch(()=>{}); }

            // Helper to run inline scripts from fetched HTML
            function runScripts(container){
                const scripts = container.querySelectorAll('script');
                scripts.forEach(old => {
                    const s = document.createElement('script');
                    if (old.src) s.src = old.src;
                    if (old.type) s.type = old.type;
                    if (!old.src) s.textContent = old.textContent;
                    document.body.appendChild(s);
                    document.body.removeChild(s);
                });
            }

            async function loadUrl(url, addToHistory = true){
                try{
                    const res = await fetch(url, {cache: 'no-store'});
                    if(!res.ok) throw new Error('Network response was not ok');
                    const text = await res.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    const newContent = doc.querySelector('#pjax-content') || doc.querySelector('main') || doc.body;
                    const newTitle = doc.querySelector('title');
                    if(newContent){
                        const target = document.getElementById('pjax-content');
                        if(target){
                            target.innerHTML = newContent.innerHTML;
                            runScripts(target);
                            window.scrollTo(0,0);
                        } else {
                            // fallback full navigation
                            window.location.href = url;
                        }
                    }
                    if(newTitle) document.title = newTitle.textContent;
                    if(addToHistory) history.pushState({url:url}, '', url);
                }catch(err){
                    console.error('PJAX load failed:', err);
                    window.location.href = url;
                }
            }

            document.addEventListener('click', function(e){
                const a = e.target.closest('a');
                if(!a) return;
                const href = a.getAttribute('href');
                if(!href) return;
                // ignore external links and anchors
                if(href.startsWith('http') && new URL(href, location.href).origin !== location.origin) return;
                if(href.startsWith('#') || a.target === '_blank' || a.hasAttribute('download') || a.href.indexOf('mailto:') === 0) return;
                e.preventDefault();
                const url = new URL(href, location.href).href;
                if(url === location.href) return;
                loadUrl(url);
            }, true);

            window.addEventListener('popstate', function(e){
                loadUrl(location.href, false);
            });
        })();
    </script>
                <!-- Global mute/unmute floating control (persistent) -->
                <div class="audio-toggle" aria-hidden="false">
                    <button id="global-audio-toggle" title="Toggle audio">ðŸ”ˆ</button>
                </div>

                <script>
                    (function(){
                        const btn = document.getElementById('global-audio-toggle');
                        const audio = document.getElementById('bg-audio');
                        if(!btn) return;
                        function update(){
                            try{ const muted = sessionStorage.getItem('bgMuted') === '1'; btn.textContent = muted ? 'ðŸ”‡' : 'ðŸ”ˆ'; }catch(e){}
                        }
                        btn.addEventListener('click', function(){
                            try{
                                const muted = sessionStorage.getItem('bgMuted') === '1';
                                const newMuted = !muted;
                                sessionStorage.setItem('bgMuted', newMuted ? '1' : '0');
                                if(audio){ audio.muted = newMuted; if(!newMuted) audio.play().catch(()=>{}); }
                                update();
                            }catch(e){ console.warn(e); }
                        });
                        try{ const muted = sessionStorage.getItem('bgMuted') === '1'; if(audio) audio.muted = muted; update(); }catch(e){}
                    })();
                </script>
</body>
</html>